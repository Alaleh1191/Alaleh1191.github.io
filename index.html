<!DOCTYPE html>
	<head>
		<!-- Styling -->
		<link href="style.css" rel="stylesheet">
		
		<!-- D3 v4 -->
		<script src="https://d3js.org/d3.v4.min.js"></script>
		
		<!-- Custom "chord" and "ribbon" functions -->
		<script src="arc.js"></script>
		<script src="chord.js"></script>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
		
		<link href="flat/blue.css" rel="stylesheet">
		<script src="icheck.js"></script>
		<link href='//fonts.googleapis.com/css?family=Capriola' rel='stylesheet'>
		<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
	</head>
	<body>
			<div>
				<form>
					<span>Please enter the sequence for transcript:</span><br/>
					<div id = "SVs" style="position:relative">
						<!--<span class= "1"> 1. </span>-->
						<span class= "1"> Name: </span>
						<input type="text" name="name1" class="1" value="1" onfocus="onFocus(this)" onblur="onBlur(this)">
						<span class= "1"> Sequence: </span>
						<textarea class ="SV 1" style="width: 525px;  height: 13px; margin-bottom: -5px"></textarea>
						
						<img class = "del 1" onclick="removeSV(this)" src="x-button.png" alt="delete" height="19px" style= "margin-bottom:-5px" title="delete this transcript"><!--http://tdyln.me/tdyln-0065-x-10-july-2015/ cite this-->
						<br class = "1"/>
						<span class = "2"> Name: </span>
						<input type="text" name="name2" class="2" value="2" onfocus="onFocus(this)" onblur="onBlur(this)">
						<span class= "2"> Sequence: </span>
						<textarea class ="SV 2"  style="width: 525px; height: 13px; margin-bottom: -5px"></textarea>
						<img class ="del 2" onclick="removeSV(this)" src="x-button.png" alt="delete" height="19px" style= "margin-bottom:-5px">
						<br class = "2"/>
					</div>
					<img onclick="addSV()" src='http://www.clker.com/cliparts/e/6/d/7/1194994263582955302add.svg.thumb.png' alt='Addition Plus Sign clip art' style="position: relative;" height= "20px"/><br class="addSV"/>
					<span> Alternatively select a transcript by selecting a gene and species (ENSEMBLE):</span> <br/>
					<span> Species: </span>
					<select id="species"></select>
					<span> Gene: </span>
					<input type="text" id="gene"/>
					<input type="button" value="Select Specie and Gene" class="button1" onclick="searchForGene();"/> <br/>
					<select id="transcripts"></select>
					<input type="button" value="Add Transcript to the list" class="button1" onclick="searchForTranscript();"/><br/>
					<input type="button" value="All Transcripts" class="button1" onclick="allTranscriptsInSelectedGene();"/><br/>
					<span>Please enter the minimum length of a share sequence: </span>
					<input type="text" name="minLength" id='minLength' value="20" onfocus="if (this.value==20) this.value = ''" onblur="if (this.value=='') this.value = 20"><br/>
					<span style="margin-right: 15px">Weight Probes by:</span>
					<input type="radio" name="weight" value="length" checked> Length of the Probe <span style="margin-left: 15px"></span>
  					<input type="radio" name="weight" value="shared"> Number of Transcripts Containing the Probe<br>
					
				</form>

				<span>------- AND/OR --------</span>
				<!--<form>
					
				</form> displayTranscripts();-->
				<input type="button" value="Submit" onclick="chordData();" class="btn btn-primary button">
			</div>


			<div  style="width: 525px;white-space: pre-wrap;word-wrap: break-word;"><span id = "results"></span></div>
			<div id="sv-chart" style="width: 700px; float: left; position: absolute;"></div>
			<div style="width: 500px; margin-left: 750px;" id="probeLoc">  </div>

			<div id="title" style="display: none;text-anchor: middle;width: 500px; margin-left: 750px; word-wrap: break-word"> Please click on the probe to get its sequence </div>

			<script src="script.js"></script>


			<script>

             /*   var transcriptsGlobal = [];


				window.onload = (function() {
				    var xhr = new XMLHttpRequest();
				    xhr.open('GET', '//rest.ensembl.org/info/species?content-type=application/json');
				    xhr.onreadystatechange = (function() {
				        if(xhr.status == 200 && xhr.readyState == 4)
						{
							var species = JSON.parse(xhr.responseText);
							species = species.species;

							var speciesOptions = '';
							for(var i = 0; i < species.length; i++)
							{
								speciesOptions += '<option value="' + species[i].name + '">' + species[i].display_name + '</option>';
							}

							document.getElementById('species').innerHTML = speciesOptions;

						}
					});
					xhr.send();
					$('select').select2();
					$(".select2").removeAttr("style");
				});

				function searchForGene()
				{
					var specie = document.getElementById('species');
					specie = specie.options[specie.selectedIndex].value;

					var gene = document.getElementById('gene').value;

					var xhr = new XMLHttpRequest();
					xhr.open('GET', '//rest.ensembl.org/lookup/symbol/'+specie+'/'+gene+'?content-type=application/json;expand=1');
					xhr.onreadystatechange = (function() {
					   if(xhr.status == 200 && xhr.readyState == 4)
					   {
                           var transcripts = JSON.parse(xhr.responseText);
                           transcripts = transcripts['Transcript'];
                           transcriptsGlobal = transcripts;

							transcriptsOptions = '';
							for(var i = 0; i < transcripts.length; i++)
							{
								console.log("transcript info");
								console.log(transcripts[i])
                                transcriptsOptions += '<option value="' + i + '">' + transcripts[i].display_name + ' (' + transcripts[i].biotype + ')</option>';
							}

							document.getElementById('transcripts').innerHTML = transcriptsOptions;
					   }
					   else if(xhr.readyState == 4)
					   {
					       alert('Supplied Specie and Gene was not found');
                           transcriptsGlobal = [];
					   }
					});

					xhr.send(null);
				}

				function searchForTranscript()
				{
					var placed = -1;
					for(var i=1; i < numberOfSV; i++){
                        if($(".SV."+i).val() == ""){
                        	placed = i;
                        	break;
                        }
                    }
                    if(placed != -1){
                    	$(".del."+(placed-1)).css("position", "relative");
                    	$("br."+placed).before("<img id='loading' src='Loading_icon.gif' alt='loading' style='height: 60px; margin-bottom: -25px; margin-left: -58px;margin-top: -37px;' /> ");
                    } else{
                    	$("br.addSV").before("<img id='loading' src='Loading_icon.gif' alt='loading' style='height: 60px; margin-bottom: -19px; margin-left: -25px;margin-top: -35px;' /> ")
                    }
                    
					var transcript = document.getElementById('transcripts');
                    transcript = transcript.options[transcript.selectedIndex].value;
                    transcript = transcriptsGlobal[transcript];

                    console.log('Transcript ID' + transcript['id'] + ' - Transcript Name: ' + transcript['display_name']);

                    var exons = transcript['Exon'];
                    console.log(exons);
                    var exonIds = {};
                    exonIds['ids'] = [];
                    exonIds['format'] = 'JSON';

                    for (var i = 0; i < exons.length; i++)
                    {
                        exonIds['ids'].push(exons[i]['id']);
                    }

                    exonIds = JSON.stringify(exonIds);

                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '//rest.ensembl.org/sequence/id');
                    xhr.setRequestHeader("Content-Type", "text/plain");
                    xhr.onreadystatechange = function() {
                        if(xhr.readyState == 4 && xhr.status == 200)
                        {
                            var sequence = xhr.responseText;
                            sequence = sequence.split("\n");
                            sequence = sequence.join('');
                            console.log(sequence);
                            console.log("number of sv is"+numberOfSV);
                            
                            $("#loading").remove();
                            if(placed == -1){
                            	addSV(transcript['display_name'], sequence);
                            } else {
                            	$(".SV."+placed).val(sequence);
                        		$( "input[name='name"+placed+"']" ).val(transcript['display_name']);
                        		//$("br."+i).before("<img src='Loading_icon.gif' alt='loading'")
                        		
                            }
                            

                        }
                    }

                    xhr.send(exonIds);
				}
*/

			</script>




			<script type="text/javascript">
				$(document).ready(function(){
				  $('input').iCheck({
				    checkboxClass: 'icheckbox_flat-blue',
				    radioClass: 'iradio_flat-blue'
				  });
				});
				numberOfSV = 3;

				function displayTranscripts(){
					$("#title").css("display","block");
					$("#probeLoc").empty();

					var spliceVariants= $(".SV").map(function() {
					   return $(this).val();
					}).get();

					//var orgSplice = spliceVariants
					//console.log(spliceVariants);
					var longestSeq = spliceVariants.sort(function (a, b) { return b.length - a.length; })[0];
					//console.log("longest" + longestSeq.length);

					spliceVariants= $(".SV").map(function() {
					   return $(this).val();
					}).get();

					var xScale = d3.scaleLinear()//scaleLinear v4
				        .domain(
				         	[0,longestSeq.length]
				        )
				        .range([0,580]);


				    // Zooming behavior, only zoom on the x-Axis
					//var zoom = d3.zoom()
					    //.x(xScale)
					  //  .on("zoom", zoomed);
					var height = spliceVariants.length * 30 + 20;

				    var svg = d3.select("#probeLoc")
							.append("svg")
							.attr("id", "svgT")
							.attr("width", "700px")
							.attr("class" , "svg")
							.attr("height", height)
							.append("g")
						  //  .call(zoom)
						  	.append("g")
						  	.attr("class", "g");

					 // Create the x-Axis
					/*var xAxis = d3.svg.axis()
					    .scale(xScale)
					    .orient("bottom")
					    .tickSize(-height);

					svg.append("g")
					    .attr("class", "x axis")
					    .attr("transform", "translate(0," + height + ")")
					    .call(xAxis);*/


					//Color for the unique locations
					var locations = [$( "input[name='name"+1+"']" ).val(), $( "input[name='name"+2+"']" ).val(), $( "input[name='name"+3+"']" ).val(), $( "input[name='name"+4+"']" ).val(),  $( "input[name='name"+5+"']" ).val(), $( "input[name='name"+6+"']" ).val(), $( "input[name='name"+7+"']" ).val(), $( "input[name='name"+8+"']" ).val(),  $( "input[name='name"+9+"']" ).val(), $( "input[name='name"+10+"']" ).val(), $( "input[name='name"+11+"']" ).val(), $( "input[name='name"+12+"']" ).val(), $( "input[name='name"+13+"']" ).val(), $( "input[name='name"+14+"']" ).val(), $( "input[name='name"+15+"']" ).val(), $( "input[name='name"+16+"']" ).val(), $( "input[name='name"+17+"']" ).val()];
					//var colors = ["#FE7351", "#38BEB7","#FBA89A", "#DBE380", "#FE6C5F", "#EBF39E", "#ECE8DD", "#D8F5F0" , "#1395B5" , "#14D9C8" , "#D7E643" , "#CEEBFB" , "#E5726B", "#EA706F" , "#CFCA6F", "#F1E64E", "#FFD2C3"];
					var colors = [ "#1395B5", "#FE7351","rgb(130, 195, 53)",  "#EA706F" ,  "#F1E64E", "#B3AEB2", "#14D9C8" , "rgb(154, 4, 4)", "rgb(49, 152, 206)", "rgb(62, 165, 5)", "#D7E643", "#7486c3", "rgb(64, 135, 24)","#FE6C5F", "#F1E64E", "#98B914",];
					var color = d3.scaleOrdinal()
				    	.domain(locations)
				    	.range(colors);

					svg.append("rect")
					    .attr("class", "overlay")
					    .attr("width", "700px")
					    .attr("height", height);

					var text = svg.append("g").attr("class", "text");
					var yloc = 10;

					for(var i = 0; i < spliceVariants.length; i++){
						var name = $( "input[name='name"+(i+1)+"']" ).val();
						//console.log(name)
						// Each Transcript
						svg.append("rect")
				            .attr("x", 0)
				            .attr("y", yloc)
				            .attr("width", xScale(spliceVariants[i].length))
				            .attr("height", 20)
				            .style("opacity", 0.85)
							.attr("fill", color(name));

						// The name of the gene
						d3.select(".svg").append("text")
							.attr("class", "vals")
							.attr("x", xScale(spliceVariants[i].length)+10)
				            .attr("y", yloc+15)
				            .text(name)
				           // .attr("font-family", "sans-serif")
				            .style("font-size", "17px")
				            .style('pointer-events', 'none');

				        yloc += 30;
				    }
				}

                function addSV(name, sequence){
                    if(name == null && sequence == null)
                    {
                        name = numberOfSV;
                        sequence = '';
                    }
                    $("#SVs").append("<span class='"+numberOfSV+"'> Name: </span> <input type='text' name='name"+numberOfSV+"' class='"+numberOfSV+"' value='"+name+"' onfocus='onFocus(this)' onblur='onBlur(this)'> <span class='"+numberOfSV+"'> Sequence: </span><textarea class='SV "+numberOfSV+"' style='width: 525px;  height: 13px; margin-bottom: -5px'>"+sequence+"</textarea><span class="+numberOfSV+" style='margin-right: 4px;'></span><img class='del "+numberOfSV+"' onclick='removeSV(this)' src='x-button.png' alt='delete' height='19px' style='margin-bottom: -5px'> <br class='"+numberOfSV+"'/>")
                    numberOfSV++;
                }

				function onFocus(sv){
					//console.log($( "input[name='name"+sv.className+"']" ).val());
					//console.log(sv.className);
					if($( "input[name='name"+sv.className+"']" ).val()==sv.className) 
						$( "input[name='name"+sv.className+"']" ).val("");
					//else
						//console.log("error")
				}

				function onBlur(sv) {
					if($( "input[name='name"+sv.className+"']" ).val()=='')
						{$( "input[name='name"+sv.className+"']" ).val(sv.className);}
				}
				function removeSV(sv){
					sv = sv.className;
					sv = sv.match(/\d+/)[0]; //get the number
					var remove = "."+sv
					$(remove).remove();
					//console.log("num" + numberOfSV);
					//console.log("sv" + sv)
					while(sv < numberOfSV){
						sv++;
						var toggleClass = "."+ sv;
						var newClass = sv-1;
						//console.log(toggleClass);
						//console.log(newClass);
						if($( "input[name='name"+sv+"']" ).val() == sv){
							$( "input[name='name"+sv+"']" ).val(newClass);
						}
						
						$( "input[name='name"+sv+"']" ).attr("name", "name"+newClass)
						$(toggleClass).addClass(newClass.toString()).removeClass(sv.toString());
						
					//	$(toggleClass).addClass(newClass).removeClass("'"+sv+"'");
					}
					numberOfSV--;
				}


				function zoomed() {
					
					// zoom behavior of svg	  
					translate = [d3.event.translate[0], 0];
					svg.attr("transform", "translate(" + translate + ")scale(" + d3.event.scale + ", 1)");
				
					// zoom behavior of texts 
					d3.selectAll(".vals").each(function(i, d){
						
						if(vals.length < numtext){
							vals[d] = d3.select(this).attr("x")
						} 
					
						val = vals[d] * d3.event.scale + d3.event.translate[0];
					
						d3.select(this).attr("x", val);

					})
				}



				function findProbes(sv){
					
					
					var spliceVariants = sv;
					console.log("replace error!");
					console.log(spliceVariants);
					var minLength = Number($("#minLength").val());

					var numVariants = spliceVariants.length;
					var sharePartnersPerSV = new Array(numVariants);
					var convergencehx = [1, 0]
					var numericSpliceVariants= new Array(numVariants);

					for(var i = 0; i < numVariants ; i++){
						numericSpliceVariants[i] = nucleotidesStrToVector(spliceVariants[i]);
					}
					
					var sharez = [];
					var sharedSequences = [];
					var sharedHolder = [];
					var merged = [];

					while(sharedSequences.length != 1){
						
						if(sharedSequences.length == 0){

							for(var i = 0; i < numericSpliceVariants.length - 1; i+=2) {

								sharez =  nucleotideSequenceCompare(numericSpliceVariants[i], numericSpliceVariants[i+1], minLength);
								merged = [].concat.apply([], sharez);
								
								if(sharez.length == 0) {
									return;

								} else {
									sharedSequences.push(merged);
								}
								
							}

							if((numericSpliceVariants.length%2) != 0){
								sharedSequences.push(numericSpliceVariants[numericSpliceVariants.length-1]);
							}

						} else {
							sharedHolder = sharedSequences;
							sharedSequences = [];
							for(var i = 0; i < sharedHolder.length - 1; i+=2){
								sharez = nucleotideSequenceCompare(sharedHolder[i], sharedHolder[i+1], minLength);
								merged = [].concat.apply([], sharez);
								if(sharez.length == 0) {
									return;

								}
								sharedSequences.push(merged);
							}

							if((sharedHolder.length%2) != 0){
								sharedSequences.push(sharedHolder[sharedHolder.length-1]);
							}
						}
					
					}
					var probe = [];
					var possProbe = [];
					sharedSequences = [].concat.apply([], sharedSequences);

					for(var i = 0; i<sharedSequences.length; i++) {
						if(sharedSequences[i] != 0){
							possProbe.push(sharedSequences[i]);
						} else {
							if(possProbe.length >= minLength){//not the largerst possProbe.length > probe.length
								probe.push(possProbe);
							}
							possProbe = [];
						}
					}
					

					var finalProbe = ""
					var finalProbes = [];
					for(var i = 0; i< probe.length; i++) {
						finalProbe = "";
						for(var j = 0; j<probe[i].length; j++){
							if(probe[i][j] == 1){
								finalProbe = finalProbe.concat("A");
							} else if(probe[i][j] == 2) {
								finalProbe = finalProbe.concat("C");
							} else if(probe[i][j] == 3) {
								finalProbe = finalProbe.concat("G");
							} else {
								finalProbe = finalProbe.concat("T");
							}
						}
						
						finalProbes.push(finalProbe);
					}
					finalProbes = finalProbes.filter( function( item, index, inputArray ) {
						           		return inputArray.indexOf(item) == index;
						    		});
					/*console.log("finalized Probes Before");
					console.log(finalProbes);
					var i = 0, j = 1;
					while(i < finalProbes.length && j < finalProbes.length){
						if(finalProbes[j].includes(finalProbes[i])){
							finalProbes.splice(i, 1);
						} else if (finalProbes[i].includes(finalProbes[j])){
							finalProbes.splice(j, 1);
						} else {
							i++; j++;
						}
					}
					console.log("finalized Probes After");
					console.log(finalProbes);*/
					return finalProbes;
				}

				function nucleotidesStrToVector(inputStr){
					inputStr = inputStr.replace(/[a-z]/g, '');
					inputStr = inputStr.replace(/A/g, "1 ");
					inputStr = inputStr.replace(/C/g, "2 ");
					inputStr = inputStr.replace(/G/g, "3 ");
					inputStr = inputStr.replace(/T/g, "4 ");
					var output = inputStr.split(" ").map(Number);;
					output.pop();
					return output;
				}

				function chordData(){

					$("#results").empty();
					$("#sv-chart").empty();

					

					var sequences = $(".SV").map(function() {
					   return $(this).val();
					}).get();

					var arrComb = [];
					var arrSharedSeqs = [];

					

					//create an array of combinations (so far combinations of just 1 element)
					for (var i = 0; i < sequences.length - 1; i++) {
						arrComb.push([i]);
					}

					// create an array of shared sequences, so far just sequences
					for (var i = 0; i < sequences.length - 1; i++) {
						arrSharedSeqs.push([sequences[i]])
					}

					var newComb = [];
					var indexSeq = 0;
					var indexComb = 0;
					var minLength = Number($("#minLength").val());
					var probes, uniqueProbes = [], temp;
					while (indexComb < arrComb.length){
						var comb = arrComb[indexComb];
						console.log(comb);
						var last = comb[comb.length - 1];
							for(var j = last+1; j < sequences.length; j++){
								probes = [];
								uniqueProbes = [];
								indexSeq = 0;
								while(indexSeq < arrSharedSeqs[indexComb].length){
									temp = findProbes([sequences[j], arrSharedSeqs[indexComb][indexSeq]]);
									
									if(temp == null){
										indexSeq++;
										continue;
									}
									probes = probes.concat(temp);
								
									if(temp.indexOf(arrSharedSeqs[indexComb][indexSeq]) != -1){
										arrSharedSeqs[indexComb].splice(indexSeq, 1);
									} else{
										indexSeq++;
									}
									
								}

								if(probes.length == 0){
									continue;
								}
								
								$.each(probes, function(i, el){
								    if($.inArray(el, uniqueProbes) === -1) uniqueProbes.push(el);
								});

								if(uniqueProbes.length != 0){
									arrSharedSeqs.push(uniqueProbes);
									newComb = comb.concat([j]);
									arrComb.push(newComb);
								}
							}
						if (arrSharedSeqs[indexComb].length == 0 || comb.length == 1) {
							arrComb.splice(indexComb, 1);
							arrSharedSeqs.splice(indexComb, 1);
						} else{
							indexComb++;
						}
								
					}

					makeJsonData(arrComb, arrSharedSeqs);


				}

				function makeJsonData(combs, sharedSeqs){
					var length = true; 

					if($('input[name=weight]:checked').val() == "shared"){
						length = false;
						var weights = [];
					}

					var arrayOfProbes = [];
					var chordData = [];

					for(var i = combs.length - 1; i > -1; i--){
						for( var j = 0; j < sharedSeqs[i].length; j++){
							if(arrayOfProbes.indexOf(sharedSeqs[i][j]) == -1){
								arrayOfProbes.push(sharedSeqs[i][j]);
								if(!length){
									weights.push(combs[i].length);
								}
								for(var k = 0; k < combs[i].length; k++){
									chordData.push({
										"SpliceVariant": $( "input[name='name"+(combs[i][k]+1)+"']" ).val(),
										"probe": sharedSeqs[i][j],
										"size": sharedSeqs[i][j].length
									});
								}
							}
						}
					}

					var temp = [];

					for(var i = 0; i < arrayOfProbes.length; i++){
						if(!length){
							temp.push({
								"name" : arrayOfProbes[i],
								"size" : weights[i]*10
							})
						} else {
							temp.push({
								"name" : arrayOfProbes[i],
								"size" : arrayOfProbes[i].length 
							})
						}
						
					}
					var temp2 = [];
					temp2.push({
						"children": temp
					})
					weightedByLength = {"children": temp2};
				//	console.log(weightedByLength);
					if(chordData.length != 0){
						drawChord(chordData, weightedByLength);
						displayTranscripts();
					} else {
						$("#results").html("no SVs of desired min length was found");
					}

				}

				function nucleotideSequenceCompare(sequence1, sequence2, minLengthShared) {
					var sharez = [];

					var i = 1;

					var start1O = sequence1.length-1;
					var start2O = 0;
					var diff = [];
					while(i < (sequence2.length+sequence1.length)){
						diff = [];
						var possible = [];
						var start1 = start1O;
						var start2 = start2O;
						var k = 0;
						while(start1 < sequence1.length && start2 < sequence2.length){
							diff[k] = sequence1[start1] - sequence2[start2];
							if(diff[k] == 0) {
								possible.push(sequence1[start1]);
							} else {
								if(possible.length >= minLengthShared && possible.length > 0){
									sharez.push(possible);
									sharez.push([0]); // separator
								}
								possible = [];
							}
							start1++;
							start2++;
							k++;
						}
						if(possible.length >= minLengthShared && possible.length > 0){
							sharez.push(possible);
							sharez.push([0]); // separator
						}

						i++;
						if (start1O != 0) {
							start1O--;
							start2O = 0;
						} else {
							start2O++;
						}
					}

					return sharez;
					
				}

			</script>
			<script type="text/javascript" src="ensemble.js"></script>
	</body>
</html>
